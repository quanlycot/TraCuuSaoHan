<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Tra Cứu & Gửi Sớ (An Yên)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    input:focus, textarea:focus, select:focus { background-color: rgba(251, 191, 36, 0.1) !important; border-color: #f59e0b !important; outline: none; box-shadow: 0 0 0 1px #f59e0b; }
    .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; color: white; }
    
    /* Màu sắc Ngũ Hành (Mới) */
    .badge-menh-kim { background: #f1f5f9; color: #475569; border: 1px solid #cbd5e1; }
    .badge-menh-moc { background: #dcfce7; color: #166534; border: 1px solid #86efac; }
    .badge-menh-thuy { background: #e0f2fe; color: #075985; border: 1px solid #7dd3fc; }
    .badge-menh-hoa { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .badge-menh-tho { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }

    /* Hiệu ứng Fade In */
    .animate-fade-in { animation: fadeIn 0.6s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    /* Table Styles */
    .custom-table { width: 100%; border-collapse: collapse; }
    .custom-table th, .custom-table td { border: 1px solid #475569; padding: 8px; text-align: left; }
    .custom-table th { background-color: rgba(30, 41, 59, 0.8); color: #94a3b8; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; }
    .custom-table tr:hover { background-color: rgba(51, 65, 85, 0.5); }
    
    .tab-active { border-bottom: 2px solid #f59e0b; color: #f59e0b; }
    .tab-inactive { border-bottom: 2px solid transparent; color: #94a3b8; }
    .tab-inactive:hover { color: #cbd5e1; }
    
    /* Input Enter Helper */
    .input-enter {}
  </style>
</head>
<body class="min-h-screen bg-[#0f172a] text-slate-200 selection:bg-amber-500/30 pb-10">
  
  <div id="loading" class="loading-overlay hidden">
    <i class="fa-solid fa-circle-notch fa-spin text-4xl text-amber-500 mb-4"></i>
    <p class="text-lg font-medium">Đang xử lý dữ liệu...</p>
  </div>

  <div class="bg-slate-900/90 backdrop-blur border-b border-slate-700 shadow-lg sticky top-0 z-50">
      <div class="max-w-6xl mx-auto px-4">
          <div class="flex flex-col md:flex-row items-center justify-between py-3 gap-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-amber-500 to-amber-700 flex items-center justify-center text-xl shadow-lg shadow-amber-900/30 text-white">☯</div>
                <div>
                    <h1 class="text-xl font-bold text-amber-500 leading-tight">Tra Cứu & Gửi Sớ</h1>
                    <p id="headerYear" class="text-slate-400 text-xs"></p>
                </div>
            </div>
            <div class="flex gap-6 text-sm font-bold uppercase tracking-wide">
                <button id="tabBtnLookup" class="pb-2 transition-all tab-active"><i class="fa-solid fa-magnifying-glass mr-1"></i> Tra Cứu Vận Hạn</button>
                <button id="tabBtnList" class="pb-2 transition-all tab-inactive"><i class="fa-solid fa-paper-plane mr-1"></i> Gửi Danh Sách Cầu An/Siêu</button>
            </div>
            <div class="flex gap-2 items-center">
                <label class="text-slate-400 text-xs uppercase hidden md:block">Năm xem</label>
                <input id="selectedYear" type="number" min="1900" max="2099" step="1" class="w-20 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-sm text-center focus:border-amber-500 outline-none" />
                <button id="btnResetApp" class="px-2 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs"><i class="fa-solid fa-rotate-right"></i></button>
            </div>
          </div>
      </div>
  </div>

  <div class="max-w-6xl mx-auto p-4 md:p-6 relative z-10">
    
    <div id="tabLookup" class="flex flex-col gap-6 animate-fade-in">
        
        <div id="currentTamTaiBox" class="bg-orange-900/10 border border-orange-500/20 rounded-xl p-4 hidden">
            <div class="flex items-start gap-3">
                <i class="fa-solid fa-triangle-exclamation text-orange-500 mt-1"></i>
                <div>
                    <h3 class="text-orange-400 font-bold text-sm uppercase mb-1">Lưu ý Tam Tai năm nay</h3>
                    <p id="tamTaiListText" class="text-slate-400 text-sm leading-relaxed"></p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
            <div class="md:col-span-4 bg-slate-800/40 rounded-2xl border border-slate-700/50 p-6 shadow-xl h-fit">
                <h3 class="text-amber-500 text-xs font-bold uppercase tracking-wider mb-5 flex items-center gap-2">
                    <i class="fa-regular fa-id-card"></i> Thông tin Tín Chủ
                </h3>
                <div class="space-y-4" id="formLookup">
                    <div>
                        <label class="block text-[11px] text-slate-500 uppercase mb-1 font-semibold">Họ và Tên</label>
                        <input type="text" id="fullName" placeholder="VD: Nguyễn Văn A" class="input-enter w-full bg-slate-900/50 border border-slate-600 rounded-lg px-3 py-2.5 text-sm transition-all focus:ring-1 focus:ring-amber-500/50" />
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[11px] text-slate-500 uppercase mb-1 font-semibold">Năm sinh (DL)</label>
                            <input type="number" id="birthYear" placeholder="VD: 1985" class="input-enter w-full bg-slate-900/50 border border-slate-600 rounded-lg px-3 py-2.5 text-sm transition-all" />
                        </div>
                        <div>
                            <label class="block text-[11px] text-slate-500 uppercase mb-1 font-semibold">Tuổi Âm</label>
                            <input type="number" id="ageInput" placeholder="VD: 41" class="input-enter w-full bg-slate-900/50 border border-slate-600 rounded-lg px-3 py-2.5 text-sm transition-all" />
                        </div>
                    </div>

                    <div>
                         <label class="block text-[11px] text-slate-500 uppercase mb-1 font-semibold">Giới tính</label>
                        <div class="flex bg-slate-900/50 rounded-lg p-1 border border-slate-600">
                            <button type="button" id="btnGenderMale" class="flex-1 py-2 rounded-md text-sm font-medium transition-all bg-slate-700 text-amber-400 shadow-sm">Nam</button>
                            <button type="button" id="btnGenderFemale" class="flex-1 py-2 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-slate-200">Nữ</button>
                        </div>
                    </div>

                    <button id="btnCalculate" type="button" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-amber-600 to-amber-500 hover:from-amber-500 hover:to-amber-400 text-slate-900 font-bold py-3 px-4 rounded-lg transition-all shadow-lg mt-2 group">
                        <span>Xem Luận Giải</span> <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <div class="md:col-span-8">
                <div id="resultCard" class="min-h-[400px]">
                    <div id="resultEmpty" class="h-full flex flex-col justify-center items-center opacity-30 border-2 border-dashed border-slate-800 rounded-2xl p-8">
                        <i class="fa-solid fa-seedling w-16 h-16 mx-auto mb-4 text-slate-400 text-6xl"></i>
                        <p class="text-base text-center font-light">Nhập thông tin để xem vận hạn<br>dưới góc nhìn <span class="text-amber-500">Tích Cực & Nhân Văn</span></p>
                    </div>

                    <div id="resultContent" class="hidden space-y-6 animate-fade-in">
                        
                        <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-xl border border-slate-700/50 shadow-lg p-5 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-white tracking-tight" id="resName"></h2>
                                <p class="text-slate-400 text-sm mt-1" id="resInfo"></p>
                            </div>
                            <div id="resMenhBadge" class="px-4 py-1.5 rounded-full font-bold text-sm border shadow-sm"></div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-slate-800/40 rounded-xl border border-slate-700/50 p-5 relative overflow-hidden group">
                                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-star text-6xl text-amber-500"></i></div>
                                <p class="text-xs uppercase text-slate-500 font-bold mb-2">Sao Chiếu Mệnh</p>
                                <div class="flex items-baseline gap-2 mb-2">
                                    <h3 id="resSao" class="text-2xl font-bold text-amber-400"></h3>
                                    <span id="resSaoHanh" class="text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-300"></span>
                                </div>
                                <div id="resSaoPos"></div> 
                            </div>
                            
                            <div class="bg-slate-800/40 rounded-xl border border-slate-700/50 p-5 relative overflow-hidden group">
                                 <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-scroll text-6xl text-slate-400"></i></div>
                                <p class="text-xs uppercase text-slate-500 font-bold mb-2">Hạn Niên</p>
                                <h3 id="resHan" class="text-2xl font-bold text-slate-200 mb-2"></h3>
                                <p id="resHanDesc" class="text-sm text-slate-400 leading-relaxed"></p>
                            </div>
                        </div>

                        <div class="bg-[#1e293b] rounded-xl border border-slate-700 shadow-xl overflow-hidden">
                            <div class="px-5 py-4 border-b border-slate-700 bg-slate-800/50 flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-amber-500/10 flex items-center justify-center text-amber-500"><i class="fa-solid fa-scale-balanced"></i></div>
                                <h3 class="font-bold text-slate-200 uppercase text-sm tracking-wide">Luận Giải Tương Tác (Mệnh & Sao)</h3>
                            </div>
                            <div class="p-6">
                                <div id="analysisGraph" class="flex flex-wrap items-center gap-3 text-sm text-slate-400 mb-4 font-mono"></div>
                                
                                <h4 id="analysisTitle" class="text-lg font-bold mb-3"></h4>
                                <div id="analysisContent" class="text-slate-300 text-sm leading-7 text-justify"></div>
                                
                                <div class="mt-4 pt-4 border-t border-slate-700/50 flex gap-3">
                                    <i class="fa-solid fa-quote-left text-amber-500/50 text-xl"></i>
                                    <p class="text-sm italic text-slate-400">"Sao tốt hay xấu vốn dĩ không cố định. Tâm mình hướng thiện, làm việc phước đức thì gặp Sao dữ cũng hóa lành, gặp Sao lành thì càng thêm rực rỡ."</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-slate-800/40 rounded-xl border border-slate-700 overflow-hidden">
                            <div class="px-5 py-3 border-b border-slate-700/50 flex items-center justify-between bg-slate-900/20">
                                <h3 class="font-bold text-slate-300 uppercase text-xs flex items-center gap-2"><i class="fa-solid fa-hands-praying"></i> Nghi Thức & Kiêng Kỵ</h3>
                                <span class="text-[10px] text-slate-500 uppercase tracking-wider">Hóa Giải</span>
                            </div>
                            <div class="p-5 grid grid-cols-1 sm:grid-cols-2 gap-y-4 gap-x-8 text-sm">
                                <div class="space-y-4">
                                    <div class="flex justify-between border-b border-slate-700/50 pb-2"><span class="text-slate-500">Ngày cúng:</span> <span class="text-slate-200 font-medium" id="cungTime"></span></div>
                                    <div class="flex justify-between border-b border-slate-700/50 pb-2"><span class="text-slate-500">Hướng lạy:</span> <span class="text-amber-500 font-bold" id="cungHuong"></span></div>
                                    <div class="flex justify-between border-b border-slate-700/50 pb-2"><span class="text-slate-500">Số đèn/nến:</span> <span class="text-slate-200 font-bold" id="cungDen"></span></div>
                                    <div class="bg-slate-900/50 rounded p-3 border border-slate-700/50">
                                        <span class="text-slate-500 block mb-1 text-[10px] uppercase font-bold">Bài vị (Viết trên giấy):</span>
                                        <div id="cungBaiVi" class="text-amber-200 font-serif italic text-center"></div>
                                    </div>
                                </div>

                                <div class="space-y-4">
                                    <div>
                                        <span class="text-emerald-500 block mb-1 text-xs uppercase font-bold"><i class="fa-solid fa-palette mr-1"></i> Màu Hợp (Kích Tài/Hóa Giải):</span>
                                        <div id="colorGood" class="text-emerald-100 bg-emerald-900/20 px-2 py-1.5 rounded border border-emerald-500/20"></div>
                                    </div>
                                    <div>
                                        <span class="text-rose-500 block mb-1 text-xs uppercase font-bold"><i class="fa-solid fa-ban mr-1"></i> Màu Kỵ (Nên Tránh):</span>
                                        <div id="colorBad" class="text-rose-100 bg-rose-900/20 px-2 py-1.5 rounded border border-rose-500/20"></div>
                                    </div>
                                    <div class="pt-2">
                                        <div class="bg-orange-900/10 border border-orange-500/20 rounded-lg p-3">
                                            <div class="flex items-center gap-2 mb-2">
                                                <i class="fa-solid fa-triangle-exclamation text-orange-500 text-xs"></i>
                                                <span class="text-orange-400 font-bold text-xs uppercase">Đặc Biệt Cần Thận Trọng</span>
                                            </div>
                                            <p id="starCaution" class="text-slate-300 text-sm leading-relaxed text-justify"></p>
                                            <div class="mt-2 text-xs text-slate-500 border-t border-orange-500/10 pt-1 flex justify-between">
                                                <span>Tháng kỵ (ÂL):</span>
                                                <span class="text-orange-300 font-bold" id="cungThangKy"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="resTamTai"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="tabList" class="hidden flex flex-col gap-6 animate-fade-in">
        
        <div class="bg-slate-800/80 backdrop-blur rounded-xl border border-slate-700 p-4 flex flex-col md:flex-row justify-between items-center gap-4 shadow-lg">
            <div class="flex bg-slate-900 rounded-lg p-1 border border-slate-700">
                <button id="modeCauAn" class="px-6 py-2 rounded-md text-sm font-bold transition-all bg-emerald-700 text-white shadow-lg">
                    <i class="fa-solid fa-hands-praying mr-2"></i> CẦU AN
                </button>
                <button id="modeCauSieu" class="px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700">
                    <i class="fa-solid fa-cloud-moon mr-2"></i> CẦU SIÊU
                </button>
            </div>
            <div class="flex gap-2">
                <button id="btnSaveToSheets" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium shadow-lg shadow-blue-900/20 transition-all text-sm">
                    <i class="fa-solid fa-cloud-arrow-up"></i> Gửi DS Lên Chùa (Sheet)
                </button>
                <button id="btnExport" class="flex items-center gap-2 bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium shadow-lg shadow-green-900/20 transition-all text-sm">
                    <i class="fa-solid fa-file-excel"></i> Xuất Excel
                </button>
                <button id="btnClearAll" class="bg-slate-700 hover:bg-rose-600 text-white px-3 py-2 rounded-lg transition-all" title="Xóa tất cả"><i class="fa-solid fa-trash"></i></button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-4 flex flex-col gap-4">
                <div class="bg-slate-800/60 rounded-xl border border-slate-700 p-5 shadow-lg">
                    <h3 id="masterTitle" class="text-amber-500 text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-user-tag"></i> Thông tin Gia chủ
                    </h3>
                    <div class="space-y-3" id="formMaster">
                        <input type="text" id="listMasterName" placeholder="Tên Gia Chủ..." class="input-enter w-full bg-slate-900/60 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200" />
                        <textarea id="listMasterAddress" rows="2" placeholder="Địa chỉ..." class="input-enter w-full bg-slate-900/60 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200"></textarea>
                    </div>
                </div>

                <div class="bg-slate-800/60 rounded-xl border border-slate-700 p-5 shadow-lg flex-1">
                    <h3 id="memberFormTitle" class="text-emerald-500 text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2">
                        <i class="fa-solid fa-user-plus"></i> Thêm người Cầu An
                    </h3>
                    <div class="space-y-3" id="formMember">
                        <input type="text" id="listMemberName" placeholder="Họ và Tên..." class="input-enter w-full bg-slate-900/60 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200" />
                        <input type="text" id="listMemberDharma" placeholder="Pháp danh (nếu có)..." class="input-enter w-full bg-slate-900/60 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200" />
                        
                        <div id="inputCauAnGroup" class="grid grid-cols-2 gap-2">
                             <input type="number" id="listMemberBirthYear" placeholder="Năm sinh (Vd:1990)" class="input-enter w-full bg-slate-900/60 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200" />
                             <select id="listMemberGender" class="input-enter w-full bg-slate-900/60 border border-slate-600 rounded-lg px-2 py-2 text-sm text-slate-300">
                                <option value="male">Nam</option>
                                <option value="female">Nữ</option>
                             </select>
                        </div>
                        <div id="listAgeDisplay" class="text-xs text-amber-500 text-right italic h-4"></div>

                        <div id="inputCauSieuGroup" class="hidden">
                            <input type="text" id="listMemberDeathInfo" placeholder="Tuổi lúc mất (VD: 82 tuổi)" class="input-enter w-full bg-slate-900/60 border border-slate-600 rounded-lg px-3 py-2 text-sm text-slate-200" />
                        </div>

                        <button id="btnAddMember" class="w-full mt-2 bg-slate-700 hover:bg-slate-600 text-white font-bold py-2.5 rounded-lg transition-all border border-slate-600">
                            <i class="fa-solid fa-plus mr-1"></i> Thêm vào danh sách
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div id="listDisplayCauAn" class="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden min-h-[500px]">
                    <div class="bg-slate-900/50 px-4 py-3 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="text-emerald-400 font-bold text-sm uppercase"><i class="fa-solid fa-list-ol mr-2"></i> Danh sách Cầu An</h3>
                        <span id="countCauAn" class="text-xs text-slate-500">0 người</span>
                    </div>
                    <div id="containerCauAn" class="p-4 space-y-6 max-h-[600px] overflow-y-auto"></div>
                </div>

                <div id="listDisplayCauSieu" class="hidden bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden min-h-[500px]">
                    <div class="bg-slate-900/50 px-4 py-3 border-b border-slate-700 flex justify-between items-center">
                        <h3 class="text-slate-200 font-bold text-sm uppercase"><i class="fa-solid fa-list-ol mr-2"></i> Danh sách Cầu Siêu</h3>
                        <span id="countCauSieu" class="text-xs text-slate-500">0 vong linh</span>
                    </div>
                    <div id="containerCauSieu" class="p-4 space-y-6 max-h-[600px] overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>
    
  </div>

  <footer class="text-center text-slate-600 text-xs py-6 mt-8">
      <p>Viết bởi <span class="text-amber-600 font-bold">Đồng Thịnh</span></p>
  </footer>

  <script>
    // =========================================================================
    // CẤU HÌNH LIÊN KẾT GOOGLE 
    // =========================================================================
    // Link Google Script của bạn
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxfX1NcV9wkEb11R-BHVmJ-ZqCsvcxrq22_s6Hxs9KOPiWAyT3CP5TsmXKgcx07rO8k/exec"; 

    // --- DATA & CONSTANTS (DỮ LIỆU MỚI) ---
    const Gender = { MALE: "male", FEMALE: "female" };
    const CHI = ["Thân", "Dậu", "Tuất", "Hợi", "Tý", "Sửu", "Dần", "Mão", "Thìn", "Tỵ", "Ngọ", "Mùi"];
    const CAN = ["Canh", "Tân", "Nhâm", "Quý", "Giáp", "Ất", "Bính", "Đinh", "Mậu", "Kỷ"];
    const NGU_HANH = { 1: "Kim", 2: "Thủy", 3: "Hỏa", 4: "Thổ", 5: "Mộc" };

    // DỮ LIỆU SAO: Đã cập nhật nội dung nhân văn & chi tiết nghi thức
    const SAO_DATA = {
      "La Hầu": { 
        name: "La Hầu", type: "challenge", hanhID: 1, // Kim
        cungNgay: "Mùng 8 ÂL", cungHuong: "Chính Bắc", cungDen: "9 ngọn", kyThang: "Tháng 1, Tháng 7",
        baiVi: "Thiên Cung Thần Thủ La Hầu Tinh Quân",
        mauHop: "Đen, Xanh biển (Thủy)", mauKy: "Trắng (Kim), Vàng (Thổ)",
        canThan: "Đề phòng chuyện thị phi, tranh chấp, bệnh về tai mắt và máu huyết.",
        luanGiai: "Đây là sao chủ về 'Khẩu Nghiệp'. Với người thường, nó mang đến thị phi, rắc rối. Nhưng với người tu tập, đây là cơ hội tốt nhất để học hạnh **Nhẫn Nhục** và **Cẩn Trọng Lời Nói**. Nếu biết giữ mình, không tranh cãi, thì họa tự chuyển thành phước. Đặc biệt, nam giới có vợ mang thai năm nay thì lại được 'ngược dòng' hưởng phúc, mẹ tròn con vuông."
      },
      "Kế Đô": { 
        name: "Kế Đô", type: "challenge", hanhID: 4, // Thổ
        cungNgay: "18 ÂL", cungHuong: "Chính Tây", cungDen: "21 ngọn", kyThang: "Tháng 3, Tháng 9",
        baiVi: "Địa Cung Thần Vĩ Kế Đô Tinh Quân",
        mauHop: "Trắng, Xám (Kim)", mauKy: "Vàng (Thổ), Đỏ (Hỏa)",
        canThan: "Cẩn thận giấy tờ, đừng đi đêm nơi vắng vẻ. Tâm trạng hay bất an vô cớ.",
        luanGiai: "Sao chủ về sự thử thách nội tâm. Bạn có thể cảm thấy buồn chán, tự ti mà không rõ nguyên do. Đừng sợ hãi, hãy xem đây là lúc 'đóng cửa' với bên ngoài để **Quay Về Chăm Sóc Tâm Hồn**. Siêng năng sám hối, tụng kinh thì trí tuệ sẽ sáng suốt. Riêng phụ nữ mang thai gặp Kế Đô thì lại rất hên, hóa giải được mọi tai ương."
      },
      "Thái Bạch": { 
        name: "Thái Bạch", type: "challenge", hanhID: 1, // Kim
        cungNgay: "Rằm (15) ÂL", cungHuong: "Chính Tây", cungDen: "8 ngọn", kyThang: "Tháng 2, 5, 8",
        baiVi: "Tây Phương Canh Tân Kim Đức Thái Bạch Tinh Quân",
        mauHop: "Đen, Xanh biển (Thủy)", mauKy: "Trắng (Kim)",
        canThan: "Tuyệt đối kỵ màu trắng quanh năm. Tránh các việc liên quan đến tiền bạc lớn, kỵ đám tang.",
        luanGiai: "Dân gian sợ 'sạch cửa nhà', nhưng nhà Phật nhìn nhận đây là bài học về sự **Buông Xả**. Hạn này nhắc nhở bạn đừng quá tham cầu vật chất. Thay vì lo mất tiền, hãy chủ động dùng tiền làm phước, bố thí. 'Của đi thay người', sự hao tài chủ động (làm thiện) sẽ giúp bạn giữ được bình an và tích được âm đức lớn."
      },
      "Thủy Diệu": { 
        name: "Thủy Diệu", type: "support", hanhID: 2, // Thủy
        cungNgay: "21 ÂL", cungHuong: "Chính Bắc", cungDen: "7 ngọn", kyThang: "Tháng 4, Tháng 8",
        baiVi: "Bắc Phương Nhâm Quý Thủy Đức Tinh Quân",
        mauHop: "Trắng (Kim), Xanh lá (Mộc)", mauKy: "Vàng, Nâu (Thổ)",
        canThan: "Kỵ sông nước, đi biển. Nữ giới cần tránh tranh cãi để khỏi sinh tai tiếng.",
        luanGiai: "Sao Phước Tinh mang dòng chảy hanh thông. Tài lộc và tin vui rất dễ đến. Tuy nhiên, nước có thể nâng thuyền cũng có thể lật thuyền. Đừng vì thấy may mắn mà chủ quan, lơ là. Hãy giữ tâm **Khiêm Hạ** như nước, uyển chuyển trong ứng xử thì phúc lộc mới bền lâu."
      },
      "Thái Dương": { 
        name: "Thái Dương", type: "support", hanhID: 3, // Hỏa
        cungNgay: "27 ÂL", cungHuong: "Chính Đông", cungDen: "12 ngọn", kyThang: "Tháng 6, Tháng 10",
        baiVi: "Nhật Cung Thái Dương Thiên Tử Tinh Quân",
        mauHop: "Đỏ, Hồng, Xanh lá", mauKy: "Trắng, Đen",
        canThan: "Người già, người huyết áp cao cần chú ý sức khỏe. Cẩn thận hỏa hoạn.",
        luanGiai: "Như mặt trời ban trưa rực rỡ, tốt cho công danh sự nghiệp. Nhưng **'Vật Cực Tất Phản'**, đang lúc thịnh vượng nhất là lúc cần đề phòng sự kiêu ngạo. Hãy dùng ánh sáng (thành công) của mình để soi đường, giúp đỡ người khác. Càng san sẻ phước báu, ánh hào quang của Thái Dương càng được duy trì."
      },
      "Thái Âm": { 
        name: "Thái Âm", type: "support", hanhID: 2, // Thủy
        cungNgay: "26 ÂL", cungHuong: "Chính Tây", cungDen: "7 ngọn", kyThang: "Tháng 11",
        baiVi: "Nguyệt Cung Thái Âm Hoàng Hậu Tinh Quân",
        mauHop: "Đen, Trắng, Vàng", mauKy: "Vàng sẫm (Thổ)",
        canThan: "Phụ nữ sinh nở cần chú ý an toàn. Đi lại vùng sông nước cẩn thận.",
        luanGiai: "Tượng trưng cho mặt trăng dịu hiền, chủ về sự sung túc, điền sản (đất đai). Đây là quả ngọt từ những nhân lành bạn đã gieo. Tuy nhiên, phước như nước trong hồ, dùng mãi cũng vơi. Năm nay thuận lợi, hãy tranh thủ **Gieo Duyên Lành** mới (cúng dường, ấn tống) để dòng phước không bị cạn kiệt."
      },
      "Mộc Đức": { 
        name: "Mộc Đức", type: "support", hanhID: 5, // Mộc
        cungNgay: "25 ÂL", cungHuong: "Chính Đông", cungDen: "20 ngọn", kyThang: "Ít kỵ",
        baiVi: "Đông Phương Giáp Ất Mộc Đức Tinh Quân",
        mauHop: "Xanh lá, Đen, Xanh biển", mauKy: "Trắng, Bạc",
        canThan: "Tránh leo trèo cao. Đề phòng các bệnh nhẹ về mắt.",
        luanGiai: "Sao của sự sinh sôi, nảy nở và an vui. Trẻ em gặp thì học giỏi, người lớn thì công việc ôn hòa. Lời khuyên là **Đừng Lười Biếng**. Vận may đang đến giống như hạt giống tốt gặp đất màu, nhưng nếu bạn không gieo trồng và chăm sóc thì cũng không có quả ngọt."
      },
      "Vân Hớn": { 
        name: "Vân Hớn", type: "neutral", hanhID: 3, // Hỏa
        cungNgay: "29 ÂL", cungHuong: "Chính Nam", cungDen: "15 ngọn", kyThang: "Tháng 2, Tháng 8",
        baiVi: "Nam Phương Bính Đinh Hỏa Đức Tinh Quân",
        mauHop: "Vàng, Nâu (Thổ)", mauKy: "Đỏ, Xanh lá",
        canThan: "Nóng nảy dễ hỏng việc. Cẩn thận giấy tờ pháp lý và tai nạn lửa điện.",
        luanGiai: "Sao chủ về sự bảo thủ và nóng nảy. Mọi rắc rối năm nay thường đến từ cái Tôi quá lớn. Bài học năm nay là **Lắng Nghe và Kiểm Soát Cảm Xúc**. Chỉ cần bạn biết nhu hòa, 'một câu nhịn chín câu lành' thì mọi tai ách của Vân Hớn đều tan biến, công việc vẫn bình ổn."
      },
      "Thổ Tú": { 
        name: "Thổ Tú", type: "neutral", hanhID: 4, // Thổ
        cungNgay: "19 ÂL", cungHuong: "Chính Tây", cungDen: "5 ngọn", kyThang: "Tháng 4, Tháng 8",
        baiVi: "Trung Ương Mậu Kỷ Thổ Đức Tinh Quân",
        mauHop: "Trắng, Xám (Kim)", mauKy: "Vàng, Đỏ",
        canThan: "Xuất hành đi xa không thuận. Tâm lý hay ngờ vực, không kiên định.",
        luanGiai: "Sao thử thách lòng kiên trì. Công việc có thể trì trệ, tiểu nhân gièm pha khiến bạn nản lòng. Đây là lúc rèn luyện **Nghị Lực và Sự Chân Thành**. Đừng vội vàng thay đổi, cứ làm việc chắc chắn, lấy đức độ đối đãi với tiểu nhân thì họ sẽ tự lui. 'Chậm mà chắc' là từ khóa cho năm nay."
      }
    };
    const SAO_NAM_LIST = ["La Hầu", "Thổ Tú", "Thủy Diệu", "Thái Bạch", "Thái Dương", "Vân Hớn", "Kế Đô", "Thái Âm", "Mộc Đức"];
    const SAO_NU_LIST = ["Kế Đô", "Vân Hớn", "Mộc Đức", "Thái Âm", "Thổ Tú", "La Hầu", "Thái Dương", "Thái Bạch", "Thủy Diệu"];

    const HAN_DATA = {
      "Huỳnh Tuyền": "Cần lưu ý sức khỏe, tránh làm việc quá sức. Dành thời gian nghỉ ngơi.",
      "Tam Kheo": "Chú ý đi lại xe cộ, giữ gìn chân tay. Tránh nơi xô bồ đông đúc.",
      "Ngũ Mộ": "Cẩn thận tài chính, tránh mua đồ không rõ nguồn gốc. Nên bố thí để tạo phước.",
      "Thiên Tinh": "Chú ý an toàn vệ sinh thực phẩm. Giữ tinh thần thoải mái.",
      "Tán Tận": "Tiền bạc cẩn trọng. Không nên mang đồ quý giá phô trương.",
      "Thiên La": "Gia đạo cần sự nhẫn nhịn, thấu hiểu. Chuyện to hóa nhỏ.",
      "Địa Võng": "Tránh đi khuya, tránh tranh luận vô bổ. Sống tuân thủ pháp luật.",
      "Diêm Vương": "Người bệnh cần thăm khám sớm. Người khỏe mạnh thì tài lộc vẫn tốt."
    };
    const HAN_LIST = ["Huỳnh Tuyền", "Tam Kheo", "Ngũ Mộ", "Thiên Tinh", "Tán Tận", "Thiên La", "Địa Võng", "Diêm Vương"];

    // --- HELPER FUNCTIONS ---
    const getCanChi = (year) => { return CAN[year % 10] + " " + CHI[year % 12]; };

    const getMenh = (year) => {
        let sum = ([4,4,5,5,1,1,2,2,3,3][year%10] + ([4,5,10,11].includes(year%12)?0:[6,7,0,1].includes(year%12)?1:2));
        if(sum>5) sum-=5;
        const cls = {1:"badge-menh-kim",2:"badge-menh-thuy",3:"badge-menh-hoa",4:"badge-menh-tho",5:"badge-menh-moc"};
        return {id:sum, name:NGU_HANH[sum], class:cls[sum]};
    };

    const calculateSaoHan = (birthYear, yearToCheck, gen) => {
      const age = yearToCheck - birthYear + 1;
      if (age < 10) return null;
      const saoIndex = (age - 10) % 9;
      const saoName = gen === Gender.MALE ? SAO_NAM_LIST[saoIndex] : SAO_NU_LIST[saoIndex];
      const tens = Math.floor(age / 10);
      const units = age % 10;
      let hanIndex = 0;
      if (gen === Gender.MALE) { hanIndex = (tens + units - 1) % 8; } 
      else {
        let rawIndex = (4 - ((tens - 1) + units)) % 8;
        if (rawIndex < 0) rawIndex += 8;
        hanIndex = rawIndex;
      }
      return { sao: saoName, han: HAN_LIST[hanIndex], age };
    };

    // --- LOGIC LUẬN GIẢI PHONG THỦY ---
    function analyzeRelationship(userMenhID, saoName) {
        const sao = SAO_DATA[saoName];
        if(!sao) return { title: "...", content: "...", color: "text-slate-300" };

        const saoMenhID = sao.hanhID;
        const uName = NGU_HANH[userMenhID]; 
        const sName = NGU_HANH[saoMenhID];  

        const mapSinh = {1:2, 2:5, 5:3, 3:4, 4:1};
        const mapKhac = {1:5, 5:4, 4:2, 2:3, 3:1};

        let relation = "HOA";
        if (userMenhID === saoMenhID) relation = "HOA"; 
        else if (mapSinh[saoMenhID] === userMenhID) relation = "SAO_SINH_MENH"; 
        else if (mapSinh[userMenhID] === saoMenhID) relation = "MENH_SINH_SAO"; 
        else if (mapKhac[userMenhID] === saoMenhID) relation = "MENH_KHAC_SAO"; 
        else if (mapKhac[saoMenhID] === userMenhID) relation = "SAO_KHAC_MENH"; 

        let title="", content="", color="text-slate-300";

        if (relation === "HOA") {
            title = "ĐẠI CÁT (Tương Hòa - Cùng Mạng)";
            content = `Bản mệnh ${uName} và Sao ${sName} tuy hai mà một. Sự đồng hành này tạo nên thế vững chãi. Đây là thế **Tốt Nhất** giúp bạn làm chủ vận mệnh, chuyển hung thành cát.`;
            color = "text-emerald-400"; 
        } else if (relation === "SAO_SINH_MENH") {
            title = "ĐƯỢC TRỢ LỰC (Sao sinh Mệnh)";
            content = `Sao thuộc hành ${sName} sinh dưỡng cho Bản mệnh ${uName}. Sao mang năng lượng đến nuôi dưỡng bản mệnh. Đây là thế **Tốt thứ 2**, nhận được nhiều may mắn.`;
            color = "text-emerald-400"; 
        } else if (relation === "MENH_SINH_SAO") {
            if(sao.type === "support") { 
                title = "TỐT VỪA (Sinh Xuất)";
                content = `Bản mệnh ${uName} sinh cho Sao tốt ${sName}. Bạn được sao tốt chiếu, nhưng bản thân phải nỗ lực bỏ công sức thì mới thu hoạch được thành quả.`;
                color = "text-emerald-200";
            } else { 
                title = "HÓA GIẢI (Tiết Khí)";
                content = `Bản mệnh ${uName} sinh cho Sao ${sName}. Đây là cách hóa giải tự nhiên: Bản mệnh làm mềm dịu sự khắc nghiệt của sao, khiến cái xấu tự tiêu tan.`;
                color = "text-emerald-300";
            }
        } else if (relation === "MENH_KHAC_SAO") {
             title = "XUNG KHẮC (Mệnh khắc Sao)";
             content = `Bản mệnh ${uName} đi khắc chế Sao ${sName}. Đi khắc người khác thì bản thân cũng tổn hao năng lượng. Bạn cần giữ gìn sức khỏe.`;
             color = "text-amber-400"; 
        } else if (relation === "SAO_KHAC_MENH") {
            title = "KHẮC NHẬP (Sao khắc Mệnh)";
            content = `Sao hành ${sName} khắc Bản mệnh ${uName}. Hãy xem đây là cơ hội "Lửa thử vàng" để rèn luyện bản lĩnh.`;
            color = "text-rose-400"; 
        }
        return { title, content, color };
    }

    // --- STATE & DOM ---
    let currentYear = new Date().getFullYear();
    let lookupGender = Gender.MALE;
    let listCauAn = [];
    let listCauSieu = [];
    let currentListMode = "CAU_AN";

    const elSelectedYear = document.getElementById("selectedYear");
    const elHeaderYear = document.getElementById("headerYear");
    
    // Tab Elements
    const tabBtnLookup = document.getElementById("tabBtnLookup");
    const tabBtnList = document.getElementById("tabBtnList");
    const tabLookup = document.getElementById("tabLookup");
    const tabList = document.getElementById("tabList");

    // Lookup Elements
    const elTamTaiBox = document.getElementById("currentTamTaiBox");
    const elTamTaiListText = document.getElementById("tamTaiListText");
    const elBirthYear = document.getElementById("birthYear");
    const elAgeInput = document.getElementById("ageInput");
    const elFullName = document.getElementById("fullName");
    const btnCalculate = document.getElementById("btnCalculate");
    const btnGenderMale = document.getElementById("btnGenderMale");
    const btnGenderFemale = document.getElementById("btnGenderFemale");
    const elResultContent = document.getElementById("resultContent");
    const elResultEmpty = document.getElementById("resultEmpty");

    // List Elements
    const btnModeCauAn = document.getElementById("modeCauAn");
    const btnModeCauSieu = document.getElementById("modeCauSieu");
    const elMasterTitle = document.getElementById("masterTitle");
    const elMemberFormTitle = document.getElementById("memberFormTitle");
    const elInputCauAnGroup = document.getElementById("inputCauAnGroup");
    const elInputCauSieuGroup = document.getElementById("inputCauSieuGroup");
    const elListDisplayCauAn = document.getElementById("listDisplayCauAn");
    const elListDisplayCauSieu = document.getElementById("listDisplayCauSieu");
    const elListMasterName = document.getElementById("listMasterName");
    const elListMasterAddress = document.getElementById("listMasterAddress");
    const elListMemberName = document.getElementById("listMemberName");
    const elListMemberDharma = document.getElementById("listMemberDharma");
    const elListMemberBirthYear = document.getElementById("listMemberBirthYear");
    const elListMemberGender = document.getElementById("listMemberGender");
    const elListMemberDeathInfo = document.getElementById("listMemberDeathInfo");
    const elListAgeDisplay = document.getElementById("listAgeDisplay");
    const btnAddMember = document.getElementById("btnAddMember");
    const elContainerCauAn = document.getElementById("containerCauAn");
    const elContainerCauSieu = document.getElementById("containerCauSieu");
    const elCountCauAn = document.getElementById("countCauAn");
    const elCountCauSieu = document.getElementById("countCauSieu");

    // --- INIT ---
    function init() {
        elSelectedYear.value = currentYear;
        updateHeaderYear();
        
        // Tab Events
        tabBtnLookup.addEventListener("click", () => switchTab("lookup"));
        tabBtnList.addEventListener("click", () => switchTab("list"));
        
        // Global Year Change
        elSelectedYear.addEventListener("change", (e) => {
            currentYear = parseInt(e.target.value);
            updateHeaderYear();
            if(!elResultEmpty.classList.contains("hidden")) btnCalculate.click();
            renderListCauAn(); 
        });

        document.getElementById("btnResetApp").addEventListener("click", () => location.reload());

        // --- LOOKUP EVENTS ---
        btnGenderMale.addEventListener("click", () => { lookupGender = Gender.MALE; renderLookupGender(); });
        btnGenderFemale.addEventListener("click", () => { lookupGender = Gender.FEMALE; renderLookupGender(); });
        elBirthYear.addEventListener("input", () => {
             const y = parseInt(elBirthYear.value);
             if(y) elAgeInput.value = currentYear - y + 1; else elAgeInput.value = "";
        });
        elAgeInput.addEventListener("input", () => {
            const a = parseInt(elAgeInput.value);
            if(a) elBirthYear.value = currentYear - a + 1; else elBirthYear.value = "";
        });
        btnCalculate.addEventListener("click", handleLookupCalculate);

        // --- LIST EVENTS ---
        btnModeCauAn.addEventListener("click", () => setListMode("CAU_AN"));
        btnModeCauSieu.addEventListener("click", () => setListMode("CAU_SIEU"));
        elListMemberBirthYear.addEventListener("input", (e) => {
             const y = parseInt(e.target.value);
             if(y) elListAgeDisplay.textContent = `${currentYear - y + 1} tuổi`; else elListAgeDisplay.textContent = "";
        });
        btnAddMember.addEventListener("click", handleAddMember);
        document.getElementById("btnClearAll").addEventListener("click", () => {
            if(confirm("Xóa toàn bộ danh sách?")) { listCauAn=[]; listCauSieu=[]; renderListCauAn(); renderListCauSieu(); }
        });
        document.getElementById("btnSaveToSheets").addEventListener("click", saveToGoogleSheets);
        document.getElementById("btnExport").addEventListener("click", exportExcel);

        // --- ENTER KEY LOGIC ---
        setupEnterKeyNavigation("formLookup", "btnCalculate");
        setupEnterKeyNavigation("formMaster", "listMemberName");
        setupEnterKeyNavigation("formMember", "btnAddMember");
    }

    function setupEnterKeyNavigation(containerId, finalActionIdOrNextId) {
        const container = document.getElementById(containerId);
        if(!container) return;
        container.addEventListener("keydown", function(e) {
            if (e.key === "Enter") {
                if (e.target.classList.contains("input-enter") || e.target.tagName === "SELECT") {
                    e.preventDefault();
                    const allInputs = Array.from(container.querySelectorAll(".input-enter"));
                    const visibleInputs = allInputs.filter(input => input.offsetParent !== null);
                    const currentIndex = visibleInputs.indexOf(e.target);
                    if (currentIndex >= 0 && currentIndex < visibleInputs.length - 1) {
                        visibleInputs[currentIndex + 1].focus();
                    } else {
                        const finalEl = document.getElementById(finalActionIdOrNextId);
                        if(finalEl) { finalEl.focus(); if(finalEl.tagName === "BUTTON") finalEl.click(); }
                    }
                }
            }
        });
    }

    // --- COMMON LOGIC ---
    function updateHeaderYear() {
        elHeaderYear.textContent = "Năm " + getCanChi(currentYear) + " (" + currentYear + ")";
        const checkChiIndex = currentYear % 12;
        let affectedGroups = [];
        if ([6,7,8].includes(checkChiIndex)) affectedGroups.push("Thân, Tý, Thìn");
        if ([0,1,2].includes(checkChiIndex)) affectedGroups.push("Dần, Ngọ, Tuất");
        if ([3,4,5].includes(checkChiIndex)) affectedGroups.push("Tỵ, Dậu, Sửu");
        if ([9,10,11].includes(checkChiIndex)) affectedGroups.push("Hợi, Mão, Mùi");

        if (affectedGroups.length > 0) {
            elTamTaiBox.classList.remove("hidden");
            elTamTaiListText.innerHTML = `Năm <strong>${getCanChi(currentYear)}</strong>, các tuổi <b>${affectedGroups.join(" / ")}</b> phạm Tam Tai.`;
        } else elTamTaiBox.classList.add("hidden");
    }

    function switchTab(tab) {
        if(tab === "lookup") {
            tabLookup.classList.remove("hidden"); tabList.classList.add("hidden");
            tabBtnLookup.className = "pb-2 transition-all tab-active"; tabBtnList.className = "pb-2 transition-all tab-inactive";
        } else {
            tabLookup.classList.add("hidden"); tabList.classList.remove("hidden");
            tabBtnLookup.className = "pb-2 transition-all tab-inactive"; tabBtnList.className = "pb-2 transition-all tab-active";
        }
    }

    // --- LOOKUP FUNCTIONS ---
    function renderLookupGender() {
        if(lookupGender === Gender.MALE) {
            btnGenderMale.className = "flex-1 py-2 rounded-md text-sm font-medium transition-all bg-slate-700 text-amber-400 shadow-sm";
            btnGenderFemale.className = "flex-1 py-2 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-slate-200";
        } else {
            btnGenderMale.className = "flex-1 py-2 rounded-md text-sm font-medium transition-all text-slate-400 hover:text-slate-200";
            btnGenderFemale.className = "flex-1 py-2 rounded-md text-sm font-medium transition-all bg-slate-700 text-amber-400 shadow-sm";
        }
    }

    function handleLookupCalculate() {
        const y = parseInt(elBirthYear.value);
        if(!y) { alert("Vui lòng nhập Năm sinh"); return; }
        
        const calc = calculateSaoHan(y, currentYear, lookupGender);
        if(!calc) { alert("Tuổi nhỏ chưa tính hạn."); return; }
        
        const menh = getMenh(y);
        const saoInfo = SAO_DATA[calc.sao];
        const hanText = HAN_DATA[calc.han];
        const analysis = analyzeRelationship(menh.id, calc.sao);
        const fullName = elFullName.value || "Tín Chủ";

        elResultEmpty.classList.add("hidden");
        elResultContent.classList.remove("hidden");

        document.getElementById("resName").textContent = fullName;
        document.getElementById("resInfo").textContent = `${calc.age} tuổi (${getCanChi(y)}) - ${lookupGender===Gender.MALE?"Nam Mạng":"Nữ Mạng"}`;
        const bdg = document.getElementById("resMenhBadge");
        bdg.textContent = menh.name; bdg.className = `px-4 py-1.5 rounded-full font-bold text-sm border shadow-sm ${menh.class}`;

        document.getElementById("resSao").textContent = saoInfo.name;
        document.getElementById("resSaoHanh").textContent = `Hành ${NGU_HANH[saoInfo.hanhID]}`;
        
        const elPos = document.getElementById("resSaoPos"); 
        elPos.className = "mt-3 text-sm text-slate-300 leading-relaxed border-t border-slate-700/50 pt-2 text-justify";
        elPos.innerHTML = `<strong class="text-amber-500 block mb-1 text-xs uppercase"><i class="fa-solid fa-om mr-1"></i> Bản chất & Lời khuyên:</strong> ${saoInfo.luanGiai}`;
        
        document.getElementById("resHan").textContent = calc.han;
        document.getElementById("resHanDesc").textContent = hanText;

        document.getElementById("analysisGraph").innerHTML = `<span class="text-slate-500">Mệnh ${menh.name}</span> <i class="fa-solid fa-arrow-right text-slate-600"></i> <span class="text-amber-500 font-bold">Sao ${NGU_HANH[saoInfo.hanhID]}</span>`;
        const anaTitle = document.getElementById("analysisTitle");
        anaTitle.textContent = analysis.title;
        anaTitle.className = `text-lg font-bold mb-3 ${analysis.color}`;
        document.getElementById("analysisContent").innerHTML = analysis.content;

        document.getElementById("cungTime").textContent = saoInfo.cungNgay + " (19h-21h)";
        document.getElementById("cungHuong").textContent = saoInfo.cungHuong;
        document.getElementById("cungDen").textContent = saoInfo.cungDen;
        document.getElementById("colorGood").textContent = saoInfo.mauHop;
        document.getElementById("colorBad").textContent = saoInfo.mauKy;
        document.getElementById("cungBaiVi").textContent = saoInfo.baiVi;
        document.getElementById("starCaution").textContent = saoInfo.canThan;
        document.getElementById("cungThangKy").textContent = saoInfo.kyThang;

        const tCheck = ([0,4,8].includes(y%12)&&[6,7,8].includes(currentYear%12)) ||
                       ([6,10,2].includes(y%12)&&[0,1,2].includes(currentYear%12)) ||
                       ([9,1,5].includes(y%12)&&[3,4,5].includes(currentYear%12)) ||
                       ([3,7,11].includes(y%12)&&[9,10,11].includes(currentYear%12));
        
        const ttDiv = document.getElementById("resTamTai");
        if(tCheck) ttDiv.innerHTML = `<div class="p-3 bg-orange-900/20 border border-orange-500/30 rounded text-orange-300 text-sm text-center italic"><i class="fa-solid fa-triangle-exclamation mr-1"></i> Năm nay gặp hạn Tam Tai. Nên giữ tâm bình an, tránh khởi sự lớn.</div>`;
        else ttDiv.innerHTML = "";
    }

    // --- LIST FUNCTIONS ---
    function setListMode(mode) {
        currentListMode = mode;
        if(mode === "CAU_AN") {
            btnModeCauAn.className = "px-6 py-2 rounded-md text-sm font-bold transition-all bg-emerald-700 text-white shadow-lg";
            btnModeCauSieu.className = "px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700";
            elMasterTitle.innerHTML = `<i class="fa-solid fa-user-tag"></i> Thông tin Gia chủ`;
            elListMasterName.placeholder = "Tên Gia Chủ...";
            elMemberFormTitle.innerHTML = `<i class="fa-solid fa-user-plus"></i> Thêm người Cầu An`;
            elMemberFormTitle.className = "text-emerald-500 text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2";
            
            elInputCauAnGroup.classList.remove("hidden"); elListAgeDisplay.classList.remove("hidden"); elInputCauSieuGroup.classList.add("hidden");
            elListDisplayCauAn.classList.remove("hidden"); elListDisplayCauSieu.classList.add("hidden");
        } else {
            btnModeCauAn.className = "px-6 py-2 rounded-md text-sm font-bold transition-all text-slate-400 hover:text-white hover:bg-slate-700";
            btnModeCauSieu.className = "px-6 py-2 rounded-md text-sm font-bold transition-all bg-slate-200 text-slate-800 shadow-lg";
            elMasterTitle.innerHTML = `<i class="fa-solid fa-hands-holding-circle"></i> Người đứng cúng`;
            elListMasterName.placeholder = "Người đại diện cúng...";
            elMemberFormTitle.innerHTML = `<i class="fa-solid fa-user-minus"></i> Thêm người đã mất`;
            elMemberFormTitle.className = "text-slate-300 text-xs font-bold uppercase tracking-wider mb-3 flex items-center gap-2";
            
            elInputCauAnGroup.classList.add("hidden"); elListAgeDisplay.classList.add("hidden"); elInputCauSieuGroup.classList.remove("hidden");
            elListDisplayCauAn.classList.add("hidden"); elListDisplayCauSieu.classList.remove("hidden");
        }
    }

    function handleAddMember() {
        const master = elListMasterName.value.trim();
        const addr = elListMasterAddress.value.trim();
        const name = elListMemberName.value.trim();
        const dharma = elListMemberDharma.value.trim();

        if(!master) { alert("Chưa nhập tên Gia chủ/Tín chủ"); elListMasterName.focus(); return; }
        if(!name) { alert("Chưa nhập họ tên người cần thêm"); elListMemberName.focus(); return; }

        if(currentListMode === "CAU_AN") {
            const y = parseInt(elListMemberBirthYear.value);
            if(!y) { alert("Chưa nhập năm sinh"); return; }
            listCauAn.push({ id: Date.now(), master, address: addr, name, dharma, year: y, gender: elListMemberGender.value });
            renderListCauAn();
        } else {
            const deathInfo = elListMemberDeathInfo.value.trim();
            listCauSieu.push({ id: Date.now(), master, address: addr, name, dharma, deathInfo });
            renderListCauSieu();
        }

        // Reset fields
        elListMemberName.value = ""; elListMemberDharma.value = ""; elListMemberBirthYear.value = ""; elListMemberDeathInfo.value = ""; elListAgeDisplay.textContent = ""; elListMemberName.focus();
    }

    function renderListCauAn() {
        elCountCauAn.textContent = listCauAn.length + " người";
        const groups = {};
        listCauAn.forEach(p => { const k = p.master + "|" + p.address; if(!groups[k]) groups[k] = []; groups[k].push(p); });
        
        let html = "";
        Object.keys(groups).forEach(key => {
            const [master, addr] = key.split("|");
            html += `<div class="bg-slate-900/40 border border-slate-700 rounded-lg overflow-hidden mb-4">
                <div class="px-3 py-2 bg-emerald-900/20 border-b border-slate-700/50 text-sm">
                    <span class="text-slate-400">Gia chủ:</span> <strong class="text-emerald-400 uppercase">${master}</strong> 
                    <span class="mx-2 text-slate-600">|</span> <span class="text-slate-400">Đ/C:</span> <span class="text-slate-300">${addr}</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="custom-table text-sm text-slate-300">
                        <thead><tr>
                            <th class="w-8 text-center">STT</th>
                            <th>Họ Tên</th>
                            <th>Pháp Danh</th>
                            <th class="w-16">Năm</th>
                            <th class="w-12 text-center">Tuổi</th>
                            <th>Sao / Hạn</th>
                            <th class="w-20 text-center">Tam Tai</th>
                            <th class="w-10 text-center">Xóa</th>
                        </tr></thead>
                        <tbody>`;
            groups[key].forEach((p, idx) => {
                const calc = calculateSaoHan(p.year, currentYear, p.gender);
                
                // Tam Tai Check
                const tCheck = ([0,4,8].includes(p.year%12)&&[6,7,8].includes(currentYear%12)) ||
                               ([6,10,2].includes(p.year%12)&&[0,1,2].includes(currentYear%12)) ||
                               ([9,1,5].includes(p.year%12)&&[3,4,5].includes(currentYear%12)) ||
                               ([3,7,11].includes(p.year%12)&&[9,10,11].includes(currentYear%12));

                const saoType = SAO_DATA[calc ? calc.sao : ""]?.type;
                const saoColor = saoType === "support" ? "text-emerald-400" : (saoType === "challenge" ? "text-rose-400" : "text-amber-400");

                html += `<tr>
                    <td class="text-center opacity-50">${idx+1}</td>
                    <td class="font-bold text-white">${p.name}</td>
                    <td class="italic opacity-80">${p.dharma || ""}</td>
                    <td>${p.year}<br><span class="text-[10px] opacity-70">${getCanChi(p.year)}</span></td>
                    <td class="text-center">${calc ? calc.age : "?"}</td>
                    <td><span class="${saoColor} font-bold">${calc ? calc.sao : ""}</span><br><span class="opacity-70 text-xs">${calc ? calc.han : ""}</span></td>
                    <td class="text-center">${tCheck ? `<span class="bg-rose-900 text-rose-300 px-1 rounded text-[10px] font-bold">PHẠM</span>` : "-"}</td>
                    <td class="text-center"><button onclick="removeItem('CAU_AN', ${p.id})" class="text-slate-500 hover:text-rose-500"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`;
            });
            html += `</tbody></table></div></div>`;
        });
        elContainerCauAn.innerHTML = html;
    }

    function renderListCauSieu() {
        elCountCauSieu.textContent = listCauSieu.length + " vong";
        const groups = {};
        listCauSieu.forEach(p => { const k = p.master + "|" + p.address; if(!groups[k]) groups[k] = []; groups[k].push(p); });
        
        let html = "";
        Object.keys(groups).forEach(key => {
            const [master, addr] = key.split("|");
            html += `<div class="bg-slate-900/40 border border-slate-700 rounded-lg overflow-hidden mb-4">
                <div class="px-3 py-2 bg-slate-700/30 border-b border-slate-700/50 text-sm">
                    <span class="text-slate-400">Tín chủ:</span> <strong class="text-slate-200 uppercase">${master}</strong> 
                    <span class="mx-2 text-slate-600">|</span> <span class="text-slate-400">Đ/C:</span> <span class="text-slate-300">${addr}</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="custom-table text-sm text-slate-300">
                        <thead><tr>
                            <th class="w-8 text-center">STT</th>
                            <th>Họ Tên Vong Linh</th>
                            <th>Pháp Danh</th>
                            <th>Tuổi lúc mất</th>
                            <th class="w-10 text-center">Xóa</th>
                        </tr></thead>
                        <tbody>`;
            groups[key].forEach((p, idx) => {
                html += `<tr>
                    <td class="text-center opacity-50">${idx+1}</td>
                    <td class="font-bold text-white">${p.name}</td>
                    <td class="italic opacity-80">${p.dharma || ""}</td>
                    <td>${p.deathInfo || ""}</td>
                    <td class="text-center"><button onclick="removeItem('CAU_SIEU', ${p.id})" class="text-slate-500 hover:text-rose-500"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`;
            });
            html += `</tbody></table></div></div>`;
        });
        elContainerCauSieu.innerHTML = html;
    }

    window.removeItem = (type, id) => {
        if(!confirm("Xóa dòng này?")) return;
        if(type === 'CAU_AN') { listCauAn = listCauAn.filter(x => x.id !== id); renderListCauAn(); }
        else { listCauSieu = listCauSieu.filter(x => x.id !== id); renderListCauSieu(); }
    };

    // --- SAVE & EXPORT ---
    async function saveToGoogleSheets() {
        if(listCauAn.length===0 && listCauSieu.length===0) { alert("Danh sách trống!"); return; }
        if(GOOGLE_SCRIPT_URL.includes("DÁN_URL")) { alert("LỖI: Chưa cấu hình URL Script trong code HTML!"); return; }
        
        if(!confirm("Xác nhận gửi danh sách lên Chùa?")) return;

        document.getElementById("loading").classList.remove("hidden");
        
        const dataCauAn = listCauAn.map(p => {
             const calc = calculateSaoHan(p.year, currentYear, p.gender);
             return { master: p.master, address: p.address, name: p.name, dharma: p.dharma, year: p.year, age: calc?calc.age:0, sao: calc?calc.sao:"", han: calc?calc.han:"", gender: p.gender };
        });
        const dataCauSieu = listCauSieu.map(p => ({ master: p.master, address: p.address, name: p.name, dharma: p.dharma, deathInfo: p.deathInfo }));

        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, { 
                method: "POST", 
                body: JSON.stringify({ cauAn: dataCauAn, cauSieu: dataCauSieu }) 
            });
            const json = await response.json();
            
            document.getElementById("loading").classList.add("hidden");
            if(json.result === "success") {
                alert("✅ Đã gửi thành công! A Di Đà Phật.");
            } else {
                alert("❌ Lỗi từ Server: " + JSON.stringify(json));
            }
        } catch(e) {
            document.getElementById("loading").classList.add("hidden");
            console.error(e);
            alert("❌ Lỗi kết nối! Vui lòng kiểm tra lại URL Script và Quyền truy cập (Anyone).");
        }
    }

    async function exportExcel() {
        if(listCauAn.length===0 && listCauSieu.length===0) { alert("Danh sách trống!"); return; }
        const wb = new ExcelJS.Workbook();
        
        if(listCauAn.length > 0) {
            const ws = wb.addWorksheet("Cầu An");
            ws.columns = [{width:5}, {width:25}, {width:12}, {width:8}, {width:8}, {width:20}, {width:10}];
            const groups = {}; listCauAn.forEach(p=>{ const k=p.master+"|"+p.address; if(!groups[k]) groups[k]=[]; groups[k].push(p); });
            Object.keys(groups).forEach(key => {
                const [m, a] = key.split("|");
                const row = ws.addRow([`Gia chủ: ${m} - Đ/C: ${a}`]);
                ws.mergeCells(`A${row.number}:G${row.number}`);
                row.font={bold:true}; row.fill={type:'pattern', pattern:'solid', fgColor:{argb:'FFD9EAD3'}};
                ws.addRow(["STT", "Họ Tên", "P.Danh", "Năm", "Tuổi", "Sao Hạn", "Tam Tai"]).font={bold:true};
                groups[key].forEach((p,i) => {
                    const c = calculateSaoHan(p.year, currentYear, p.gender);
                    // Check Tam Tai logic đơn giản cho Excel
                    const tCheck = ([0,4,8].includes(p.year%12)&&[6,7,8].includes(currentYear%12)) ||
                               ([6,10,2].includes(p.year%12)&&[0,1,2].includes(currentYear%12)) ||
                               ([9,1,5].includes(p.year%12)&&[3,4,5].includes(currentYear%12)) ||
                               ([3,7,11].includes(p.year%12)&&[9,10,11].includes(currentYear%12));
                    ws.addRow([i+1, p.name, p.dharma, p.year, c.age, `${c.sao}-${c.han}`, tCheck?"Phạm":""]);
                });
                ws.addRow([]);
            });
        }
        if(listCauSieu.length > 0) {
            const ws = wb.addWorksheet("Cầu Siêu");
            ws.columns = [{width:5}, {width:25}, {width:15}, {width:30}];
            const groups = {}; listCauSieu.forEach(p=>{ const k=p.master+"|"+p.address; if(!groups[k]) groups[k]=[]; groups[k].push(p); });
            Object.keys(groups).forEach(key => {
                const [m, a] = key.split("|");
                const row = ws.addRow([`Tín chủ: ${m} - Đ/C: ${a}`]);
                ws.mergeCells(`A${row.number}:D${row.number}`);
                row.font={bold:true}; row.fill={type:'pattern', pattern:'solid', fgColor:{argb:'FFFFF2CC'}};
                ws.addRow(["STT", "Họ Tên Vong", "P.Danh", "Tuổi lúc mất"]).font={bold:true};
                groups[key].forEach((p,i) => ws.addRow([i+1, p.name, p.dharma, p.deathInfo]));
                ws.addRow([]);
            });
        }
        const buf = await wb.xlsx.writeBuffer();
        saveAs(new Blob([buf]), `Danh_Sach_So_${currentYear}.xlsx`);
    }

    init();
  </script>
</body>
</html>
